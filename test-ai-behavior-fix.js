// Script para diagnosticar e testar os problemas espec√≠ficos de IA
// Execute no console do navegador ap√≥s fazer login

let testResults = {
  generalButtonTest: null,
  individualButtonTest: null,
  n8nResponse: null,
  frontendCallbacks: []
};

function testAIBehaviorProblems() {
  console.log('üîç TESTANDO PROBLEMAS ESPEC√çFICOS DE IA...');
  
  // Resetar resultados
  testResults = {
    generalButtonTest: null,
    individualButtonTest: null,
    n8nResponse: null,
    frontendCallbacks: []
  };
  
  // Interceptar fetch para monitorar chamadas
  const originalFetch = window.fetch;
  window.fetch = async function(...args) {
    const [url, options] = args;
    
    if (url && url.includes && url.includes('ai-webhook')) {
      console.log('\nüöÄ === INTERCEPTANDO CHAMADA AI ===');
      
      const requestBody = options?.body ? JSON.parse(options.body) : null;
      console.log('üì§ Request Body:', requestBody);
      
      // Identificar tipo de chamada
      const dynamicFields = Object.keys(requestBody || {}).filter(key => 
        !['text', 'content', 'type', 'selectedModelTitle', 'timestamp'].includes(key)
      );
      
      const isGeneralButton = dynamicFields.length > 0 && !requestBody.content;
      const isIndividualButton = requestBody.content && requestBody.content.includes('Gere uma descri√ß√£o m√©dica');
      
      if (isGeneralButton) {
        console.log('üéØ TIPO: Bot√£o GERAL (deveria popular Resultado Final + campos individuais)');
        console.log('üìä Campos din√¢micos enviados:', dynamicFields);
        testResults.generalButtonTest = { type: 'general', fields: dynamicFields, payload: requestBody };
      } else if (isIndividualButton) {
        console.log('üéØ TIPO: Bot√£o INDIVIDUAL (deveria popular apenas campo espec√≠fico)');
        console.log('üìù Prompt:', requestBody.content);
        testResults.individualButtonTest = { type: 'individual', prompt: requestBody.content, payload: requestBody };
      } else {
        console.log('üéØ TIPO: Outro processamento');
      }
      
      const response = await originalFetch.apply(this, args);
      
      // Analisar resposta
      const clonedResponse = response.clone();
      try {
        const responseData = await clonedResponse.json();
        console.log('\nüì• === RESPOSTA RECEBIDA ===');
        console.log('Status:', response.status);
        console.log('Success:', responseData.success);
        
        if (responseData.processed_content) {
          console.log('üìÑ Processed Content:', responseData.processed_content.substring(0, 100) + '...');
        }
        
        if (responseData.individual_fields) {
          console.log('üéØ Individual Fields PRESENTES:', Object.keys(responseData.individual_fields));
          Object.entries(responseData.individual_fields).forEach(([key, value]) => {
            console.log(`  ${key}: ${value.substring(0, 50)}...`);
          });
        } else {
          console.log('‚ùå Individual Fields AUSENTES');
        }
        
        // Armazenar resposta baseada no tipo
        if (isGeneralButton) {
          testResults.generalButtonTest.response = responseData;
          console.log('\nüîç AN√ÅLISE BOT√ÉO GERAL:');
          console.log('‚úÖ Processed Content:', !!responseData.processed_content);
          console.log('‚ùì Individual Fields:', !!responseData.individual_fields);
          
          if (!responseData.individual_fields) {
            console.log('üö® PROBLEMA: Bot√£o geral n√£o retornou campos individuais!');
          }
        } else if (isIndividualButton) {
          testResults.individualButtonTest.response = responseData;
          console.log('\nüîç AN√ÅLISE BOT√ÉO INDIVIDUAL:');
          console.log('‚úÖ Processed Content:', !!responseData.processed_content);
          console.log('‚ùì Individual Fields:', !!responseData.individual_fields);
          
          if (responseData.individual_fields) {
            console.log('üö® PROBLEMA: Bot√£o individual retornou campos individuais (deveria ser s√≥ texto)!');
          }
        }
        
      } catch (e) {
        console.error('‚ùå Erro ao fazer parse da resposta:', e);
      }
      
      return response;
    }
    
    return originalFetch.apply(this, args);
  };
  
  // Interceptar logs do frontend
  const originalLog = console.log;
  console.log = function(...args) {
    const message = args[0];
    if (typeof message === 'string') {
      if (message.includes('[useAtendimentoHelpers]') || 
          message.includes('[NovoAtendimento]') || 
          message.includes('[ResultadoExames]')) {
        testResults.frontendCallbacks.push(args);
        console.log('\nüéØ === CALLBACK FRONTEND ===');
        originalLog.apply(this, args);
      } else {
        originalLog.apply(this, args);
      }
    } else {
      originalLog.apply(this, args);
    }
  };
  
  console.log('‚úÖ Monitoramento ativo.');
  console.log('üìã Execute os testes:');
  console.log('1. Preencha campos e clique "Processar com IA" (bot√£o geral)');
  console.log('2. Clique no √≠cone de IA de um campo espec√≠fico (bot√£o individual)');
}

// Fun√ß√£o para testar N8N diretamente
async function testN8NDirectResponse() {
  console.log('\nüîó TESTANDO N8N DIRETAMENTE...');
  
  const webhookUrl = 'https://n8n.mentoriajrs.com/webhook-test/c611aff7-f40b-405e-80fe-3b340a33ec9c';
  
  // Teste 1: Simular bot√£o geral (com campos din√¢micos)
  console.log('\n1Ô∏è‚É£ Teste bot√£o geral:');
  const generalPayload = {
    text: '',
    type: 'exam_result',
    timestamp: new Date().toISOString(),
    selectedModelTitle: 'Ultrassom Obst√©trico',
    IG: '32 semanas',
    BCF: '140 bpm',
    peso_fetal: '1800g'
  };
  
  try {
    const response1 = await fetch(webhookUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(generalPayload)
    });
    
    const result1 = await response1.text();
    console.log('üì• Resposta N8N (geral):', result1);
    
    try {
      const json1 = JSON.parse(result1);
      const hasIndividualFields = Object.keys(json1).some(key => 
        ['IG', 'BCF', 'peso_fetal'].includes(key)
      );
      console.log('üéØ N8N retorna campos individuais:', hasIndividualFields);
      if (hasIndividualFields) {
        console.log('‚úÖ N8N est√° funcionando corretamente para bot√£o geral');
      } else {
        console.log('‚ùå N8N N√ÉO est√° retornando campos individuais');
      }
    } catch (e) {
      console.log('üìù N8N retornou texto puro (n√£o JSON)');
    }
  } catch (error) {
    console.error('‚ùå Erro ao testar N8N geral:', error);
  }
  
  // Teste 2: Simular bot√£o individual
  console.log('\n2Ô∏è‚É£ Teste bot√£o individual:');
  const individualPayload = {
    text: 'Gere uma descri√ß√£o m√©dica normal/padr√£o para idade gestacional em um exame de ultrassonografia abdominal. Seja conciso e use terminologia m√©dica apropriada.',
    type: 'exam_result',
    timestamp: new Date().toISOString()
  };
  
  try {
    const response2 = await fetch(webhookUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(individualPayload)
    });
    
    const result2 = await response2.text();
    console.log('üì• Resposta N8N (individual):', result2);
    
    try {
      const json2 = JSON.parse(result2);
      const hasIndividualFields = Object.keys(json2).some(key => 
        ['IG', 'BCF', 'peso_fetal'].includes(key)
      );
      console.log('üéØ N8N retorna campos individuais:', hasIndividualFields);
      if (!hasIndividualFields) {
        console.log('‚úÖ N8N est√° funcionando corretamente para bot√£o individual');
      } else {
        console.log('‚ùå N8N est√° retornando campos individuais (deveria ser s√≥ texto)');
      }
    } catch (e) {
      console.log('üìù N8N retornou texto puro (correto para bot√£o individual)');
    }
  } catch (error) {
    console.error('‚ùå Erro ao testar N8N individual:', error);
  }
}

// Fun√ß√£o para gerar relat√≥rio dos problemas
function generateProblemReport() {
  console.log('\nüìã === RELAT√ìRIO DOS PROBLEMAS ===');
  
  console.log('\nüîç PROBLEMA 1: Bot√£o geral n√£o popula campos individuais');
  if (testResults.generalButtonTest) {
    const hasIndividualFields = testResults.generalButtonTest.response?.individual_fields;
    console.log('Status:', hasIndividualFields ? '‚úÖ Edge Function retorna campos' : '‚ùå Edge Function N√ÉO retorna campos');
    
    if (!hasIndividualFields) {
      console.log('üí° Poss√≠veis causas:');
      console.log('   - N8N n√£o est√° retornando campos individuais');
      console.log('   - Edge Function n√£o est√° extraindo campos corretamente');
      console.log('   - L√≥gica de mapeamento de campos est√° incorreta');
    }
  } else {
    console.log('‚ö†Ô∏è Teste do bot√£o geral n√£o foi executado');
  }
  
  console.log('\nüîç PROBLEMA 2: Bot√£o individual retorna resposta completa');
  if (testResults.individualButtonTest) {
    const hasIndividualFields = testResults.individualButtonTest.response?.individual_fields;
    console.log('Status:', !hasIndividualFields ? '‚úÖ N√£o retorna campos extras' : '‚ùå Retorna campos extras');
    
    if (hasIndividualFields) {
      console.log('üí° Poss√≠veis causas:');
      console.log('   - Bot√£o individual est√° usando mesmo fluxo do bot√£o geral');
      console.log('   - N8N est√° processando prompt individual como m√∫ltiplos campos');
      console.log('   - Edge Function est√° extraindo campos mesmo sem campos din√¢micos');
    }
  } else {
    console.log('‚ö†Ô∏è Teste do bot√£o individual n√£o foi executado');
  }
  
  console.log('\nüìä Callbacks do frontend capturados:', testResults.frontendCallbacks.length);
  
  console.log('\nüéØ PR√ìXIMOS PASSOS:');
  console.log('1. Verificar se N8N est√° configurado corretamente');
  console.log('2. Verificar l√≥gica da Edge Function');
  console.log('3. Verificar fluxo de callbacks no frontend');
  console.log('4. Implementar corre√ß√µes espec√≠ficas');
}

// Fun√ß√£o para simular comportamento correto
function simulateCorrectBehavior() {
  console.log('\nüé≠ COMPORTAMENTO CORRETO ESPERADO:');
  
  console.log('\n1Ô∏è‚É£ Bot√£o "Processar com IA" GERAL:');
  console.log('üì§ Envia: { content: "", type: "exam_result", IG: "32 semanas", BCF: "140 bpm" }');
  console.log('üì• N8N retorna: { processed_content: "texto completo", IG: "resposta IG", BCF: "resposta BCF" }');
  console.log('üéØ Resultado: Resultado Final + campos IG e BCF preenchidos');
  
  console.log('\n2Ô∏è‚É£ Bot√£o de IA INDIVIDUAL:');
  console.log('üì§ Envia: { content: "prompt espec√≠fico para IG", type: "exam_result" }');
  console.log('üì• N8N retorna: { processed_content: "resposta espec√≠fica para IG" }');
  console.log('üéØ Resultado: Apenas campo IG preenchido');
}

console.log('üöÄ Scripts dispon√≠veis:');
console.log('testAIBehaviorProblems() - Monitora comportamento atual');
console.log('testN8NDirectResponse() - Testa N8N diretamente');
console.log('generateProblemReport() - Gera relat√≥rio dos problemas');
console.log('simulateCorrectBehavior() - Mostra comportamento esperado');

// Auto-ativar monitoramento
if (typeof window !== 'undefined' && window.supabase) {
  testAIBehaviorProblems();
}